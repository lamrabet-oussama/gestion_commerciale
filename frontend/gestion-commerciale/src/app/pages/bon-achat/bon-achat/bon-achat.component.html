<div class="page-container">
  <!-- Header avec recherche -->
  <div class="card-responsive p-3 p-md-4">
    <div class="d-flex justify-content-center align-items-center gap-4 mb-4">
      <h4 class="text-center text-primary mb-0">
        <i class="fas fa-shopping-cart me-2"></i>Bon d'Achat
        <span *ngIf="selectedAchatSerie">
          N° {{selectedAchatSerie}} <span *ngIf="username">créé par {{username}}</span>
        </span>
      </h4>
    </div>

    <!-- Informations Fournisseur et Date -->
    <form class="p-2 rounded w-sm bg-white">
      <div class="section-header">
        <h5 class="section-title text-white">
          <i class="fas fa-truck me-2"></i>Informations Fournisseur & Date
        </h5>
      </div>

      <div class="row g-3 align-items-end">

        <!-- Date d'Achat -->
        <div class="col-md-6 mb-3">
          <label for="dateInput" class="form-label">Date d'Achat <span class="required">*</span></label>
          <input
            type="date"
            [(ngModel)]="selectedDate"
            (ngModelChange)="saveAllDataToDb()"
            class="form-control"
            name="dateInput"
            id="dateInput"
            [max]="maxDate"
            required
          />
        </div>

        <!-- Série -->
        <div class="col-md-6 mb-3">
          <label for="serie" class="form-label">Série</label>

          <!-- Bouton toggle -->
          <button type="button"
                  class="btn btn-sm mb-2 m-lg-1"
                  [class.btn-outline-primary]="isSerieDisabled"
                  [class.btn-primary]="!isSerieDisabled"
                  (click)="toggleSerie()">
            {{ isSerieDisabled ? 'Activer la sélection' : 'Désactiver la sélection' }}
          </button>

          <!-- Champ select -->
          <select
            class="form-select"
            id="serie"
            name="serie"
            [(ngModel)]="selectedAchatSerie"
            (ngModelChange)="onSerieSelectionChange($event)"
            [disabled]="isSerieDisabled"
          >
            <option [ngValue]="''" [selected]="true">-- Non Sélectionné --</option>
            <option *ngFor="let s of allSeris" [value]="s">
              {{ s }}
            </option>
          </select>
        </div>

        <!-- Fournisseur -->
        <div class="col-md-6 mb-3">
          <label for="fournisseur" class="form-label">Fournisseur <span class="required">*</span></label>
          <select
            class="form-select"
            id="fournisseur"
            name="fournisseur"
            [(ngModel)]="selectedFournisseurId"
            (ngModelChange)="getTierSolde($event)"
            required
          >
            <option [ngValue]="-1" [selected]="true">-- Sélectionnez un fournisseur --</option>
            <option *ngFor="let f of fournisseurs$ | async" [ngValue]="f.id">
              {{ f.nom }}
            </option>
          </select>
        </div>

        <!-- Solde Fournisseur -->
        <div class="col-md-6 mb-3">
          <label for="solde" class="form-label">Solde Fournisseur</label>
          <div class="input-group">
            <p class="form-control mb-0 text-danger border-danger">{{ soldeClient | number:'1.2-2' }}</p>
            <span class="input-group-text">DH</span>
          </div>
        </div>

        <!-- Boutons d'action pour la série -->
        <div class="col-12 d-flex justify-content-end gap-2">
          <button type="button"
                  class="btn btn-danger"
                  (click)="supprimer()"
                  [disabled]="!selectedAchatSerie">
            <i class="fas fa-trash me-1"></i> Supprimer
          </button>
        </div>

      </div>
    </form>

    <!-- Informations Article -->
    <form class="p-3 rounded w-sm bg-white mt-4">

      <!-- En-tête -->
      <div class="section-header mb-3">
        <h5 class="section-title text-white">
          <i class="fas fa-box me-2"></i> Informations Article
        </h5>
      </div>

      <!-- Première ligne -->
      <div class="row g-3 align-items-end">

        <!-- Designation prend plus d'espace -->
        <div class="col-md-4 mb-3">
          <label for="des" class="form-label">Designation <span class="required">*</span></label>
          <select
            class="form-select"
            id="des"
            name="des"
            [(ngModel)]="selectedDesignation"
            (ngModelChange)="onDesignationChange($event)"
          >
            <option value="" [selected]="true">-- Sélectionnez une designation --</option>
            <option *ngFor="let des of designations" [value]="des">
              {{ des }}
            </option>
          </select>
        </div>

        <!-- Choix -->
        <div class="col-md-3 mb-3">
          <label for="choix" class="form-label">Choix <span class="required">*</span></label>
          <select
            class="form-select"
            id="choix"
            name="choix"
            [(ngModel)]="selectedChoix"
            (ngModelChange)="onChoixChange($event)"
            [disabled]="!selectedDesignation || choix.length === 0"
          >
            <option value="" [selected]="true">-- Sélectionnez un choix --</option>
            <option *ngFor="let ch of choix" [value]="ch">
              {{ ch }}
            </option>
          </select>
        </div>

        <!-- Réf Article -->
        <div class="col-md-2 mb-3">
          <label for="refarticle" class="form-label">Réf Article</label>
          <p class="form-control mb-0 disabled-color text-gray">{{ articleAddBonDto.ref || '--' }}</p>
        </div>

        <!-- Stock -->
        <div class="col-md-2 mb-3">
          <label for="stockarticle" class="form-label">Stock</label>
          <p class="form-control mb-0 disabled-color text-gray">{{ articleAddBonDto.stock || 0 }}</p>
        </div>

        <!-- Quantité -->
        <div class="col-md-6 mb-3">
          <label for="quantite" class="form-label">Quantité <span class="required">*</span></label>
          <input
            type="number"
            class="form-control"
            id="quantite"
            min="1"
            name="quantite"
            [(ngModel)]="articleAddBonDto.quantite"
            placeholder="1"
            [disabled]="!articleAddBonDto.cod"
          />
        </div>

        <!-- Prix Vente -->
        <div class="col-md-6 mb-3">
          <label for="prixvente" class="form-label">Prix Vente</label>
          <div class="input-group">
            <p class="form-control mb-0 disabled-color text-gray">{{ (articleAddBonDto.prix || 0) | number:'1.2-2' }}</p>
            <span class="input-group-text">DH</span>
          </div>
        </div>

        <!-- Prix Achat -->
        <div class="col-md-6 mb-3">
          <label for="prixachat" class="form-label">Prix Achat</label>
          <div class="input-group">
            <p class="form-control mb-0 disabled-color text-gray">{{ (articleAddBonDto.prixAchat || 0) | number:'1.2-2' }}</p>
            <span class="input-group-text">DH</span>
          </div>
        </div>

        <!-- Prix Min -->
        <div class="col-md-6 mb-3">
          <label for="prixmin" class="form-label">Prix Min</label>
          <div class="input-group">
            <p class="form-control mb-0 disabled-color text-gray">{{ (articleAddBonDto.prixMin || 0) | number:'1.2-2' }}</p>
            <span class="input-group-text">DH</span>
          </div>
        </div>

      </div>

      <!-- Bouton Ajouter -->
      <div class="row mt-3">
        <div class="col-12 d-flex flex-column flex-sm-row justify-content-end gap-2">
          <button
            type="button"
            class="btn btn-primary btn-responsive"
            (click)="ajouterListe()"
            [disabled]="!articleAddBonDto.cod || !selectedDesignation || !selectedChoix"
          >
            <i class="fas fa-plus me-1"></i> Ajouter à la liste
          </button>
        </div>
      </div>

    </form>

  </div>

  <!-- Section Paiement -->
  <div class="payment-section">
    <div class="section-header">
      <h5 class="section-title text-white">
        <i class="fas fa-credit-card me-2"></i>Informations de Paiement
      </h5>
    </div>

    <div class="row g-3">
      <div class="col-md-6">
        <div class="payment-card">
          <h6><i class="fas fa-money-check me-2"></i>Paiement par Chèque</h6>
          <div class="row g-2">
            <div class="col-12">
              <label for="cheque" class="form-label">Montant Chèque</label>
              <div class="input-group">
                <input type="number"
                       class="form-control"
                       id="cheque"
                       name="cheque"
                       [(ngModel)]="cheque"
                       (ngModelChange)="recalculateTotal()"
                       placeholder="0.00"
                       min="0"
                       step="0.01">
                <span class="input-group-text">DH</span>
              </div>
            </div>
            <div class="col-12">
              <label for="detailscheque" class="form-label">Détails du Chèque</label>
              <textarea class="form-control"
                        id="detailscheque"
                        name="detailscheque"
                        placeholder="N° chèque, banque, date..."
                        rows="2"
                        style="resize: none;"
                        [(ngModel)]="detailsCheque"
                        (ngModelChange)="saveAllDataToDb()"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="payment-card">
          <h6><i class="fas fa-money-bill-wave me-2"></i>Paiement Espèces</h6>
          <div class="row g-2">
            <div class="col-12">
              <label for="espece" class="form-label">Montant Espèces</label>
              <div class="input-group">
                <input type="number"
                       class="form-control"
                       id="espece"
                       name="espece"
                       placeholder="0.00"
                       [(ngModel)]="espece"
                       (ngModelChange)="recalculateTotal()"
                       min="0"
                       step="0.01">
                <span class="input-group-text">DH</span>
              </div>
            </div>

            <div class="col-12">
              <label for="remissurbon" class="form-label">Remise sur bon</label>
              <div class="input-group">
                <input type="number"
                       class="form-control"
                       id="remissurbon"
                       name="remissurbon"
                       placeholder="0.00"
                       [(ngModel)]="remisSurBon"
                       (ngModelChange)="onRemisSurBonChange($event)"
                       min="0"
                       step="0.01">
                <span class="input-group-text">DH</span>
              </div>
            </div>

            <div class="col-12">
              <label for="remiseglobale" class="form-label">Remise Globale (Calculée)</label>
              <div class="input-group">
                <input type="number"
                       class="form-control"
                       [value]="remiseGlobale | number:'1.2-2'"
                       disabled
                       placeholder="0.00">
                <span class="input-group-text">DH</span>
              </div>
            </div>

            <div class="col-12">
              <label for="totalachatbrut" class="form-label">Total Brut</label>
              <div class="input-group">
                <p class="form-control mb-0 disabled-color text-gray font-weight-bold">{{ totalVenteBrute | number:'1.2-2' }}</p>
                <span class="input-group-text">DH</span>
              </div>
            </div>

            <div class="col-12">
              <label for="totalachat" class="form-label">Total de l'Achat</label>
              <div class="input-group">
                <p class="form-control mb-0 disabled-color text-success font-weight-bold">{{ totalVenteAvecRemise | number:'1.2-2' }}</p>
                <span class="input-group-text">DH</span>
              </div>
            </div>

            <div class="col-12">
              <label for="credit" class="form-label">Crédit/Dette</label>
              <div class="input-group">
                <p class="form-control mb-0"
                   [class.text-success]="credit >= 0"
                   [class.text-danger]="credit < 0">{{ credit | number:'1.2-2' }}</p>
                <span class="input-group-text">DH</span>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Boutons d'action -->
    <div class="d-flex flex-column flex-sm-row justify-content-end gap-2 mt-3">
      <button type="button"
              class="btn btn-danger btn-responsive"
              (click)="vider()">
        <i class="fas fa-ban me-1"></i> Vider
      </button>
    </div>
  </div>

  <!-- Liste des articles -->
  <div class="articles-section mt-4 mt-md-5" *ngIf="articlesAddToBon.length > 0">
    <div class="section-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-3">
      <h4 class="section-title mb-0 text-white">
        <i class="fas fa-list me-2"></i>Liste des articles
      </h4>
      <div class="search-container">
        <p class="section-title mb-0 text-white text-center mt-2 mb-0">
          <i class="fas fa-box me-1"></i>Articles: {{articlesAddToBon.length}}
        </p>
      </div>
    </div>

    <!-- Table responsive wrapper -->
    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
      <table class="table table-bordered table-hover text-center mb-0 align-middle">
        <thead class="table-dark sticky-top">
        <tr>
          <th class="text-nowrap fixed-col" style="width: 80px;">Réf</th>
          <th class="designation-col">Désignation</th>
          <th class="text-nowrap d-none d-md-table-cell fixed-col" style="width: 120px;">Choix</th>
          <th class="text-nowrap fixed-col" style="width: 120px;">Prix Vente</th>
          <th class="text-nowrap fixed-col" style="width: 120px;">Prix Achat</th>
          <th class="text-nowrap fixed-col" style="width: 100px;">Qté</th>
          <th class="text-nowrap fixed-col" style="width: 120px;">Remise Unit.</th>
          <th class="text-nowrap fixed-col" style="width: 120px;">Total</th>
          <th class="text-nowrap fixed-col" style="width: 80px;">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr class="cursor" *ngFor="let art of articlesAddToBon; trackBy: trackByArticleCode">
          <td class="text-nowrap">{{ art.ref }}</td>

          <!-- Désignation prend tout l'espace restant -->
          <td class="text-start text-truncate designation-cell" [title]="art.designation">
            {{ art.designation }}
          </td>

          <td class="d-none d-md-table-cell text-truncate" [title]="art.choix">
            {{ art.choix }}
          </td>

          <td class="text-nowrap">{{ (art.prix || 0) | number:'1.2-2' }} DH</td>
          <td class="text-nowrap">{{ (art.prixAchat || 0) | number:'1.2-2' }} DH</td>

          <td>
            <input type="number"
                   class="form-control form-control-sm text-center"
                   min="1"
                   [(ngModel)]="art.quantite"
                   (ngModelChange)="recalculateTotal()"
                   placeholder="1">
          </td>

          <td>
            <input type="number"
                   class="form-control form-control-sm text-center"
                   min="0"
                   [max]="art.prixAchat || 0"
                   [(ngModel)]="art.remisUni"
                   (ngModelChange)="recalculateTotal()"
                   placeholder="0"
                   step="0.01">
          </td>

          <td class="text-nowrap">
            {{ calculateArticleTotal(art) | number:'1.2-2' }} DH
          </td>

          <td>
            <button class="btn btn-sm btn-outline-danger"
                    (click)="supprimerArticle(art.cod ?? 0)"
                    [title]="'Supprimer ' + art.designation">
              <fa-icon [icon]="faX"></fa-icon>
            </button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- Résumé des totaux -->
    <div class="row mt-3">
      <div class="col-md-6 offset-md-6">
        <div class="card">
          <div class="card-body">
            <h6 class="card-title">Résumé</h6>
            <div class="d-flex justify-content-between">
              <span>Total Brut:</span>
              <span class="font-weight-bold">{{ totalVenteBrute | number:'1.2-2' }} DH</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Remise Totale:</span>
              <span class="text-warning">-{{ remisSurBon | number:'1.2-2' }} DH</span>
            </div>
            <hr>
            <div class="d-flex justify-content-between font-weight-bold">
              <span>Total Final:</span>
              <span class="text-success">{{ totalVenteAvecRemise | number:'1.2-2' }} DH</span>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Section de validation et impression -->
  <div class="action-section mt-4">
    <div class="row">
      <div class="col-12 d-flex flex-column flex-md-row justify-content-end gap-3">

        <!-- Bouton Valider -->
        <button type="button"
                class="btn btn-success btn-lg"
                (click)="createBonAchat()"
                [disabled]="articlesAddToBon.length === 0 || selectedFournisseurId === -1">
          <i class="fas fa-check me-2"></i>
          <span>{{ selectedAchatSerie ? 'Mettre à jour' : 'Valider le bon' }}</span>
        </button>

        <!-- Bouton Imprimer -->
        <button type="button"
                class="btn btn-primary btn-lg"
                (click)="downloadBonAchatPdf()"
                [disabled]="!selectedAchatSerie">
          <i class="fas fa-print me-2"></i>
          <span>Imprimer PDF</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Message d'aide si pas d'articles -->
  <div class="alert alert-info mt-4" *ngIf="articlesAddToBon.length === 0">
    <div class="d-flex align-items-center">
      <i class="fas fa-info-circle me-2"></i>
      <div>
        <strong>Aucun article ajouté</strong>
        <p class="mb-0">Sélectionnez une désignation et un choix, puis cliquez sur "Ajouter à la liste" pour commencer.</p>
      </div>
    </div>
  </div>

</div>
